<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - MapLeads AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK (Version 9 - Modular) -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // TODO: Replace with your actual Firebase config from Console
        // 1. Go to console.firebase.google.com
        // 2. Create Project -> Add Web App
        // 3. Copy config here
        const firebaseConfig = {
            apiKey: "AIzaSyBRV-FMPWzjDWeNzYPzCC6f7JeTRMhRXYM",
            authDomain: "maps-scrapper-6d3f9.firebaseapp.com",
            projectId: "maps-scrapper-6d3f9",
            storageBucket: "maps-scrapper-6d3f9.firebasestorage.app",
            messagingSenderId: "211512782217",
            appId: "1:211512782217:web:f0b87db923652fc1b8c558"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        const loginBtn = document.getElementById('loginBtn');
        const dashboard = document.getElementById('dashboard');
        const loginScreen = document.getElementById('loginScreen');

        const clientDashboardUrl = '/client/index.html'; // Adjust logic if hosted differently

        // Login Logic
        if (loginBtn) {
            loginBtn.addEventListener('click', () => {
                console.log("Login button clicked");
                signInWithPopup(auth, provider)
                    .then(async (result) => {
                        console.log("Logged in:", result.user.email);

                        // Sync with Firestore
                        const token = await result.user.getIdToken();
                        await fetch('http://localhost:5000/api/user/profile', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                email: result.user.email,
                                displayName: result.user.displayName,
                                photoURL: result.user.photoURL
                            })
                        });

                        if (result.user.email !== 'samadly728@gmail.com') {
                            // If not admin, redirect to Client Dashboard
                            console.log("Not admin, redirecting to Client Dashboard");
                            window.location.href = clientDashboardUrl;
                        } else {
                            // Is Admin
                            console.log("Admin logged in");
                        }
                    }).catch((error) => {
                        console.error("Login Error:", error);
                        alert("Login Failed: " + error.message);
                    });
            });
        } else {
            console.error("Login button element not found in DOM");
        }

        // Auth State Listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                if (user.email === 'samadly728@gmail.com') {
                    loginScreen.classList.add('hidden');
                    dashboard.classList.remove('hidden');
                    loadStats();
                } else {
                    // Logged in but not admin, redirect
                    window.location.href = clientDashboardUrl;
                }
            } else {
                loginScreen.classList.remove('hidden');
                dashboard.classList.add('hidden');
            }
        });

        async function loadStats() {
            try {
                const user = auth.currentUser;
                const token = await user.getIdToken();

                // Fetch Stats
                const statsResponse = await fetch('http://localhost:5000/api/admin/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const stats = await statsResponse.json();

                document.getElementById('totalUsers').innerText = stats.totalUsers || 0;
                document.getElementById('monthlyRev').innerText = "$0"; // Fallback until we implement payments
                document.getElementById('leadsScraped').innerText = stats.totalScrapes || 0;

                // Fetch Users for Table
                const usersResponse = await fetch('http://localhost:5000/api/admin/users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const users = await usersResponse.json();

                // Populate Overview Table (First 5)
                const overviewTbody = document.getElementById('userTable');
                renderUserTable(overviewTbody, users.slice(0, 5));

                // Populate All Users Table
                const allUsersTbody = document.getElementById('allUsersTable');
                renderUserTable(allUsersTbody, users, true);

            } catch (error) {
                console.error("Failed to load admin data:", error);
            }
        }

        function renderUserTable(tbody, users, detailed = false) {
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(u => {
                if (detailed) {
                    return `
                        <tr class="border-b border-gray-700 hover:bg-gray-800">
                            <td class="px-6 py-4 font-mono text-xs text-gray-500">${u.id.substring(0, 8)}...</td>
                            <td class="px-6 py-4">${u.email || 'No Email'}</td>
                            <td class="px-6 py-4"><span class="bg-gray-700 px-2 py-1 rounded text-xs">${u.role || 'user'}</span></td>
                             <td class="px-6 py-4 text-xs text-gray-400">
                                ${u.createdAt ? new Date(u.createdAt).toLocaleDateString() : 'N/A'}
                            </td>
                            <td class="px-6 py-4">
                                <button class="text-blue-400 hover:text-white text-sm">Edit</button>
                            </td>
                        </tr>
                     `;
                } else {
                    return `
                        <tr class="border-b border-gray-700 hover:bg-gray-800">
                            <td class="px-6 py-4">${u.email || 'No Email'}</td>
                            <td class="px-6 py-4">
                                <span class="bg-${u.plan === 'pro' ? 'green' : (u.plan === 'agency' ? 'purple' : 'gray')}-900 text-${u.plan === 'pro' ? 'green' : (u.plan === 'agency' ? 'purple' : 'gray')}-300 px-2 py-1 rounded text-xs capitalize">
                                    ${u.plan || 'Free'}
                                </span>
                            </td>
                            <td class="px-6 py-4">-</td>
                            <td class="px-6 py-4 text-xs text-gray-400">
                                ${u.createdAt ? new Date(u.createdAt).toLocaleDateString() : 'N/A'}
                            </td>
                        </tr>
                    `;
                }
            }).join('');
        }

        window.showAdminSection = function (sectionId) {
            document.querySelectorAll('.admin-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');

            // Update Title
            const titles = {
                'section-overview': 'Dashboard Overview',
                'section-users': 'User Management',
                'section-settings': 'Platform Settings'
            };
            document.getElementById('pageTitle').innerText = titles[sectionId] || 'Dashboard';
        };
    </script>
</head>

<body class="bg-gray-900 text-gray-200 font-sans min-h-screen">

    <div id="loginScreen" class="h-screen flex flex-col items-center justify-center">
        <h1 class="text-3xl font-bold mb-8">Login</h1>
        <button id="loginBtn"
            class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-lg font-bold flex items-center">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg"
                class="w-6 h-6 mr-3 bg-white rounded-full p-1">
            Sign in with Google
        </button>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden">
        <!-- Sidebar -->
        <div class="fixed left-0 top-0 w-64 h-full bg-gray-800 border-r border-gray-700 p-4">
            <h2 class="text-xl font-bold text-white mb-8 px-4">MapLeads Admin</h2>
            <nav class="space-y-2">
                <a href="#" onclick="showAdminSection('section-overview')"
                    class="block px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded transition">Overview</a>
                <a href="#" onclick="showAdminSection('section-users')"
                    class="block px-4 py-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded transition">Users</a>
                <a href="#" onclick="showAdminSection('section-settings')"
                    class="block px-4 py-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded transition">Settings</a>

                <div class="mt-8 border-t border-gray-700 pt-4">
                    <a href="/client/index.html" class="block px-4 py-2 text-green-400 hover:bg-gray-700 rounded">
                        <i class="fas fa-external-link-alt mr-2"></i> Switch to Client
                    </a>
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="ml-64 p-8">
            <h1 id="pageTitle" class="text-3xl font-bold text-white mb-8">Dashboard Overview</h1>

            <!-- Overview Section -->
            <div id="section-overview" class="admin-section">
                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                        <h3 class="text-gray-400 text-sm font-medium mb-2">Total Users</h3>
                        <div id="totalUsers" class="text-3xl font-bold text-white">...</div>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                        <h3 class="text-gray-400 text-sm font-medium mb-2">Monthly Revenue</h3>
                        <div id="monthlyRev" class="text-3xl font-bold text-green-400">...</div>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                        <h3 class="text-gray-400 text-sm font-medium mb-2">Leads Scraped</h3>
                        <div id="leadsScraped" class="text-3xl font-bold text-blue-400">...</div>
                    </div>
                </div>

                <!-- Recent Users -->
                <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
                    <div class="p-6 border-b border-gray-700">
                        <h3 class="text-lg font-bold text-white">Recent Users</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-400 uppercase text-xs">
                                <tr>
                                    <th class="px-6 py-3">Email</th>
                                    <th class="px-6 py-3">Plan</th>
                                    <th class="px-6 py-3">Leads</th>
                                    <th class="px-6 py-3">Joined</th>
                                </tr>
                            </thead>
                            <tbody id="userTable">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Users Section (Hidden by default) -->
            <div id="section-users" class="admin-section hidden">
                <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
                    <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-white">All Users</h3>
                        <div class="flex space-x-2">
                            <input type="text" placeholder="Search email..."
                                class="bg-gray-700 border border-gray-600 rounded px-3 py-1 text-sm text-white">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-400 uppercase text-xs">
                                <tr>
                                    <th class="px-6 py-3">ID</th>
                                    <th class="px-6 py-3">Email</th>
                                    <th class="px-6 py-3">Role</th>
                                    <th class="px-6 py-3">Created</th>
                                    <th class="px-6 py-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="allUsersTable">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Settings Section (Placeholder) -->
            <div id="section-settings" class="admin-section hidden">
                <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                    <h3 class="text-lg font-bold text-white mb-4">Platform Settings</h3>
                    <p class="text-gray-400">Settings configuration coming soon...</p>
                </div>
            </div>

        </div>
    </div>
</body>

</html>